{% extends 'base.html' %}

{% block title %}Tzahle Quiz{% endblock %}

{% block head %}
<style>
main {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}

.guess-control {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    gap: 5px;
}
</style>
{% endblock %}

{% block header %}
<h1>חידון צָהֶ"ל</h1>
{% endblock %}

{% block main %}
<div class="unit_tag">
    <a id="unit_tag_link"><img class="unit_tag_img" src="{{ c.get_full_image_path(tag) }}"></a>
</div>
<form id="form-guess" autocomplete="off">
    <input id="input-guess" type="search" value="" required autofocus>
</form>
<div id="guess-message" style="display: none"></div>
<div id="guess-answer" style="display: none"></div>
<div class="guess-control">
    <button id="guess">נחש</button>
    <button id="next">הבא</button>
    <button id="giveup">הצג תשובה</button>
</div>
<div id="score-label">ניקוד: <span id="score-num">{{ session.get('score', default=0) }}</span></div>
{% endblock %}

{% block scripts %}
<script>
    $(() => {
        let guessBtn = $("#guess")
        let guessBox = $("#input-guess")
        let message = $("#guess-message")
        let answer = $("#guess-answer")
        let score = $("#score-num")
        let giveup = $("#giveup")

        function displayAnswer(resp) {
            answer.show()
            answer.text(resp["name"])
            score.text(resp["score"])
            $("#unit_tag_link").prop("href", resp["rel_path"])
        }

        function showMessage(msg) {
            message.show()
            message.text(msg)
        }

        function answerShown() {
            // Use the visibility of the answer div to determine if the player successfully guessed already
            return answer.css("display") !== "none"
        }

        function checkGuess() {
            // Only allow guessing as long as the answer wasn't shown
            if (!answerShown()) {
                $.post({url: "quiz", data: guessBox.val(), contentType: "text/plain", success: (data) => {
                    if (data === "incorrect") {
                        showMessage("לא...")
                    } else {
                        showMessage("נחמד!")
                        displayAnswer(data)
                    }
                }});
            }
        }
        guessBox.bind("keypress", (event) => {
            if (event.which === 13) {
                event.preventDefault()
                checkGuess()
            }
        })
        guessBtn.on("click", checkGuess)

        $("#next").click(() => {
            location.reload()
        })

        giveup.click(() => {
            // Ponder upon a player guessing correctly, then pressing the show answer button only to have their
            // success nullified. That is definitely not wanted, I can assure you.
            // I mean, the effect is minimal, doing this doesn't cancel out the point earned and is quickly erased
            // when the page is reloaded, but still, it's not a good experience for the player.
            if (!answerShown()) {
                $.post({
                    url: "/quiz", data: "giveup", contentType: "text/plain", success: (data) => {
                        showMessage("חבל...")
                        displayAnswer(data)
                        guessBtn.prop("disabled", true)
                    }
                })
            }
        })
    })
</script>
<!--<script src="static/app.js"></script>-->
{% endblock %}